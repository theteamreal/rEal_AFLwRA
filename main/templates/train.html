{% extends 'base.html' %}
{% block content %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fedora ‚Äî Federated Notebook</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600;700&family=Fraunces:wght@700;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #06090F;
            --bg2: #0D1425;
            --accent: #6366F1;
            --accent2: #22D3EE;
            --success: #10B981;
            --danger: #EF4444;
            --warn: #F59E0B;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-b: rgba(255, 255, 255, 0.08);
            --text: #E2E8F0;
            --muted: #4B5563;
            --code-bg: #080C15;
            --mono: 'DM Mono', monospace;
            --sans: 'Inter', sans-serif;
            --serif: 'Fraunces', serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--sans);
            line-height: 1.5;
            padding-bottom: 120px;
        }

        /* ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            height: 58px;
            background: rgba(6, 9, 15, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-b);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            font-family: var(--serif);
            font-size: 18px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand span {
            color: var(--accent);
        }

        .brand em {
            font-style: normal;
            font-size: 12px;
            font-family: var(--mono);
            color: var(--muted);
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .topbar-right .node-id {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--muted);
        }

        .topbar-right .node-id span {
            color: var(--accent2);
        }

        .nav-btn {
            font-size: 10px;
            font-family: var(--mono);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 5px 12px;
            border-radius: 4px;
            border: 1px solid var(--glass-b);
            color: var(--muted);
            text-decoration: none;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            color: var(--text);
            border-color: var(--accent);
        }

        .nav-btn.danger {
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .nav-btn.danger:hover {
            background: rgba(239, 68, 68, 0.08);
        }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .notebook {
            max-width: 980px;
            margin: 50px auto;
            padding: 0 30px;
        }

        /* ‚îÄ‚îÄ Progress Rail ‚îÄ‚îÄ */
        .progress-rail {
            display: flex;
            align-items: center;
            gap: 0;
            margin-bottom: 50px;
            position: relative;
        }

        .progress-rail::before {
            content: '';
            position: absolute;
            top: 14px;
            left: 28px;
            right: 28px;
            height: 1px;
            background: var(--glass-b);
            z-index: 0;
        }

        .rail-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            gap: 6px;
            position: relative;
            z-index: 1;
        }

        .rail-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--glass-b);
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-family: var(--mono);
            color: var(--muted);
            transition: all 0.3s;
        }

        .rail-step.done .rail-dot {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.12);
            color: var(--success);
        }

        .rail-step.active .rail-dot {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.3);
        }

        .rail-label {
            font-size: 9px;
            font-family: var(--mono);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            text-align: center;
        }

        .rail-step.done .rail-label {
            color: var(--success);
        }

        .rail-step.active .rail-label {
            color: var(--accent);
        }

        /* ‚îÄ‚îÄ Cell ‚îÄ‚îÄ */
        .cell {
            margin-bottom: 36px;
            position: relative;
            background: var(--glass);
            border: 1px solid var(--glass-b);
            border-radius: 14px;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .cell.active {
            border-color: rgba(99, 102, 241, 0.4);
        }

        .cell.done-cell {
            border-color: rgba(16, 185, 129, 0.2);
        }

        .cell.error-cell {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .cell-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid var(--glass-b);
            background: rgba(255, 255, 255, 0.015);
        }

        .cell-head-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cell-num {
            font-family: var(--mono);
            font-size: 10px;
            color: var(--accent);
            font-weight: 700;
        }

        .cell-title {
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .cell-status {
            font-size: 10px;
            font-family: var(--mono);
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--glass);
            color: var(--muted);
        }

        .cell-status.running {
            color: var(--warn);
            background: rgba(245, 158, 11, 0.08);
            animation: blink 1s infinite;
        }

        .cell-status.ok {
            color: var(--success);
            background: rgba(16, 185, 129, 0.08);
        }

        .cell-status.fail {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.08);
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.5
            }
        }

        .cell-body {
            padding: 24px;
        }

        /* ‚îÄ‚îÄ Log Output ‚îÄ‚îÄ */
        .log-box {
            margin-top: 16px;
            background: var(--code-bg);
            border: 1px solid var(--glass-b);
            border-radius: 8px;
            padding: 14px 16px;
            font-family: var(--mono);
            font-size: 11px;
            color: #6B7280;
            max-height: 280px;
            overflow-y: auto;
            display: none;
            line-height: 1.8;
        }

        .log-box.show {
            display: block;
        }

        .log-info {
            color: #6B7280;
        }

        .log-ok {
            color: var(--success);
        }

        .log-warn {
            color: var(--warn);
        }

        .log-err {
            color: var(--danger);
        }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 9px 20px;
            border-radius: 6px;
            border: none;
            font-family: var(--mono);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #4F46E5;
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35);
        }

        .btn-primary:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--glass);
            color: var(--muted);
            border: 1px solid var(--glass-b);
        }

        .btn-secondary:hover {
            color: var(--text);
            border-color: var(--accent);
        }

        .btn-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
        label {
            display: block;
            font-size: 10px;
            font-family: var(--mono);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        input[type=number],
        select {
            width: 100%;
            background: var(--code-bg);
            border: 1px solid var(--glass-b);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 6px;
            font-family: var(--mono);
            font-size: 12px;
            outline: none;
            transition: border 0.2s;
        }

        input:focus,
        select:focus {
            border-color: var(--accent);
        }

        /* ‚îÄ‚îÄ Drop Zone ‚îÄ‚îÄ */
        .drop-zone {
            border: 2px dashed var(--glass-b);
            border-radius: 10px;
            padding: 36px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .drop-zone:hover {
            border-color: var(--accent2);
            background: rgba(34, 211, 238, 0.02);
        }

        .drop-zone.loaded {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.03);
        }

        .drop-zone .dz-icon {
            font-size: 28px;
            margin-bottom: 10px;
            opacity: 0.4;
        }

        .drop-zone .dz-text {
            font-size: 13px;
            color: var(--muted);
        }

        .drop-zone .dz-hint {
            font-size: 10px;
            font-family: var(--mono);
            color: var(--muted);
            margin-top: 6px;
            opacity: 0.5;
        }

        /* ‚îÄ‚îÄ Mode Toggle ‚îÄ‚îÄ */
        .mode-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border: 1px solid var(--glass-b);
            border-radius: 8px;
            overflow: hidden;
        }

        .mode-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 11px;
            font-family: var(--mono);
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            transition: all 0.2s;
            background: var(--glass);
        }

        .mode-tab.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
        }

        .mode-tab:hover:not(.active) {
            color: var(--text);
        }

        /* ‚îÄ‚îÄ Data Preview ‚îÄ‚îÄ */
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .preview-section h4 {
            font-size: 10px;
            font-family: var(--mono);
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .col-hist-wrap {
            height: 160px;
            position: relative;
            background: var(--code-bg);
            border: 1px solid var(--glass-b);
            border-radius: 8px;
            padding: 10px;
        }

        .data-table-wrap {
            max-height: 200px;
            overflow: auto;
        }

        .data-table-wrap table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            font-family: var(--mono);
        }

        .data-table-wrap th {
            padding: 6px 10px;
            text-align: left;
            color: var(--muted);
            background: var(--code-bg);
            position: sticky;
            top: 0;
            border-bottom: 1px solid var(--glass-b);
            white-space: nowrap;
        }

        .data-table-wrap td {
            padding: 5px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--text);
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ Target Select ‚îÄ‚îÄ */
        .target-row {
            margin-top: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* ‚îÄ‚îÄ Charts ‚îÄ‚îÄ */
        .chart-wrap {
            height: 200px;
            position: relative;
            background: var(--code-bg);
            border: 1px solid var(--glass-b);
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
        }

        .chart-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .epoch-counter {
            font-family: var(--mono);
            font-size: 12px;
            color: var(--accent);
        }

        .eta-text {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--muted);
        }

        /* ‚îÄ‚îÄ Comparison Chart ‚îÄ‚îÄ */
        .compare-wrap {
            height: 260px;
            position: relative;
            background: var(--code-bg);
            border: 1px solid var(--glass-b);
            border-radius: 8px;
            padding: 12px;
        }

        .compare-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
        }

        .cl-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--muted);
        }

        .cl-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .compare-verdict {
            margin-top: 16px;
            padding: 14px 18px;
            border-radius: 8px;
            font-size: 13px;
        }

        .verdict-better {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .verdict-worse {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .verdict-equal {
            background: rgba(245, 158, 11, 0.08);
            border: 1px solid rgba(245, 158, 11, 0.2);
            color: var(--warn);
        }

        /* ‚îÄ‚îÄ Attack Box ‚îÄ‚îÄ */
        .attack-box {
            margin-top: 16px;
            padding: 14px 16px;
            background: rgba(239, 68, 68, 0.04);
            border: 1px solid rgba(239, 68, 68, 0.15);
            border-radius: 8px;
        }

        .attack-box label {
            color: var(--danger);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attack-box input[type=checkbox] {
            width: auto;
        }

        /* ‚îÄ‚îÄ Info Pills ‚îÄ‚îÄ */
        .info-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 14px;
        }

        .info-pill {
            padding: 6px 14px;
            background: rgba(99, 102, 241, 0.07);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 20px;
            font-size: 11px;
            font-family: var(--mono);
            color: var(--accent);
        }
    </style>
</head>

<body>


    <input type="hidden" id="client-id" value="{{ client_id }}">

    <div class="notebook">

        <!-- Progress Rail -->
        <div class="progress-rail">
            <div class="rail-step" id="rail-1">
                <div class="rail-dot">1</div>
                <div class="rail-label">Sync</div>
            </div>
            <div class="rail-step" id="rail-2">
                <div class="rail-dot">2</div>
                <div class="rail-label">Load Data</div>
            </div>
            <div class="rail-step" id="rail-3">
                <div class="rail-dot">3</div>
                <div class="rail-label">Train</div>
            </div>
            <div class="rail-step" id="rail-4">
                <div class="rail-dot">4</div>
                <div class="rail-label">Push</div>
            </div>
            <div class="rail-step" id="rail-5">
                <div class="rail-dot">5</div>
                <div class="rail-label">Compare</div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Cell 1: Global Sync ‚îÄ‚îÄ -->
        <div class="cell" id="cell-1">
            <div class="cell-head">
                <div class="cell-head-left">
                    <span class="cell-num">IN [1]</span>
                    <span class="cell-title">Global State Sync</span>
                </div>
                <span class="cell-status" id="st-1">Idle</span>
            </div>
            <div class="cell-body">
                <p style="font-size:13px; color:var(--muted); margin-bottom:20px;">
                    Pull the current global model version and architecture from the Fedora Hub. This is required before
                    ingesting data.
                </p>
                <div id="info-row-1" class="info-row" style="display:none;"></div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="btn-sync" onclick="runSync()">‚ñ∂ Execute Sync</button>
                </div>
            </div>
            <div class="log-box" id="log-1"></div>
        </div>

        <!-- ‚îÄ‚îÄ Cell 2: Data Ingestion ‚îÄ‚îÄ -->
        <div class="cell" id="cell-2">
            <div class="cell-head">
                <div class="cell-head-left">
                    <span class="cell-num">IN [2]</span>
                    <span class="cell-title">Local Data Ingestion</span>
                </div>
                <span class="cell-status" id="st-2">Waiting</span>
            </div>
            <div class="cell-body">

                <!-- Mode Toggle -->
                <div class="mode-tabs">
                    <div class="mode-tab active" id="tab-clean" onclick="setMode('clean')">
                        ‚úÖ Clean CSV
                    </div>
                    <div class="mode-tab" id="tab-dirty" onclick="setMode('dirty')">
                        üßπ Raw / Dirty CSV (auto-clean)
                    </div>
                </div>
                <p id="mode-desc" style="font-size:12px; color:var(--muted); margin-bottom:16px;">
                    Upload a clean, numeric CSV file. The last column or your selected column is treated as the
                    prediction target (Y).
                </p>

                <!-- Drop Zone -->
                <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <div class="dz-icon">üìÇ</div>
                    <div class="dz-text">Click or drag to upload your CSV</div>
                    <div class="dz-hint">Supports .csv format</div>
                </div>
                <input type="file" id="file-input" style="display:none;" accept=".csv"
                    onchange="handleFile(this.files[0])">

                <!-- Column Selector + Target Selector -->
                <div id="col-settings" style="display:none;">
                    <div class="target-row">
                        <div>
                            <label>Target Feature (Y)</label>
                            <select id="target-col"></select>
                        </div>
                        <div style="display:flex; align-items:flex-end;">
                            <button class="btn btn-primary" style="width:100%;" onclick="processData()">‚ñ∂ Process
                                Dataset</button>
                        </div>
                    </div>

                    <!-- Data Preview: Column Histogram + Table -->
                    <div id="data-preview" style="display:none;">
                        <div class="preview-grid">
                            <div class="preview-section">
                                <h4>Column Value Distribution</h4>
                                <div class="col-hist-wrap">
                                    <canvas id="colHistChart"></canvas>
                                </div>
                            </div>
                            <div class="preview-section">
                                <h4>Data Preview (first 5 rows)</h4>
                                <div class="data-table-wrap" id="dataTableWrap"></div>
                            </div>
                        </div>
                        <div class="info-row" id="data-info-pills"></div>
                    </div>
                </div>

            </div>
            <div class="log-box" id="log-2"></div>
        </div>

        <!-- ‚îÄ‚îÄ Cell 3: Training ‚îÄ‚îÄ -->
        <div class="cell" id="cell-3">
            <div class="cell-head">
                <div class="cell-head-left">
                    <span class="cell-num">IN [3]</span>
                    <span class="cell-title">Browser-Side Local Training</span>
                </div>
                <span class="cell-status" id="st-3">Waiting</span>
            </div>
            <div class="cell-body">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <label>Epochs</label>
                        <input type="number" id="epochs" value="15" min="1" max="200">
                    </div>
                    <div>
                        <label>Learning Rate</label>
                        <input type="number" id="lr" value="0.005" step="0.001" min="0.0001" max="1">
                    </div>
                </div>

                <div class="chart-wrap">
                    <canvas id="lossChart"></canvas>
                </div>
                <div class="chart-meta">
                    <span class="epoch-counter" id="epoch-counter">Epoch: ‚Äî</span>
                    <span class="eta-text" id="eta-text"></span>
                </div>

                <!-- ‚îÄ‚îÄ NEW: Per-Epoch Metrics Table ‚îÄ‚îÄ -->
                <div id="epoch-table-container" style="display:none; margin-top:20px;">
                    <h5
                        style="font-family:var(--mono); font-size:10px; color:var(--muted); text-transform:uppercase; margin-bottom:10px; letter-spacing:1px;">
                        Training Progress (Per Epoch)</h5>
                    <div class="data-table-wrap" style="max-height: 200px;">
                        <table id="epoch-table">
                            <thead>
                                <tr>
                                    <th>Epoch</th>
                                    <th>Loss (MSE)</th>
                                    <th>MAE</th>
                                    <th>Improvement %</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-primary" id="btn-train" onclick="runTrain()">‚ñ∂ Run Training</button>
                </div>
            </div>
            <div class="log-box" id="log-3"></div>
        </div>

        <!-- ‚îÄ‚îÄ Cell 4: Push ‚îÄ‚îÄ -->
        <div class="cell" id="cell-4">
            <div class="cell-head">
                <div class="cell-head-left">
                    <span class="cell-num">IN [4]</span>
                    <span class="cell-title">Push to Fedora Hub</span>
                </div>
                <span class="cell-status" id="st-4">Waiting</span>
            </div>
            <div class="cell-body">
                <p style="font-size:13px; color:var(--muted); margin-bottom:16px;">
                    Broadcast your local weight updates to the global federation. Your RMSE &amp; MAE are included for
                    analytics.
                </p>
                <div class="attack-box">
                    <label>
                        <input type="checkbox" id="malicious-mode"> Malicious Mode (Simulate Gradient Sign-Flip Attack)
                    </label>
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="btn-push" onclick="runPush()">‚ñ∂ Submit Update</button>
                </div>
            </div>
            <div class="log-box" id="log-4"></div>
        </div>

        <!-- ‚îÄ‚îÄ Cell 5: Comparison ‚îÄ‚îÄ -->
        <div class="cell" id="cell-5">
            <div class="cell-head">
                <div class="cell-head-left">
                    <span class="cell-num">IN [5]</span>
                    <span class="cell-title">Model Quality Comparison</span>
                </div>
                <span class="cell-status" id="st-5">Waiting</span>
            </div>
            <div class="cell-body">
                <p style="font-size:13px; color:var(--muted); margin-bottom:16px;">
                    Compare your local model's RMSE &amp; MAE against the history of previous contributions in the
                    federation.
                </p>

                <div class="compare-legend">
                    <div class="cl-item">
                        <div class="cl-dot" style="background:#6366F1;"></div> Local RMSE (this session)
                    </div>
                    <div class="cl-item">
                        <div class="cl-dot" style="background:#22D3EE;"></div> Previous RMSE (history)
                    </div>
                    <div class="cl-item">
                        <div class="cl-dot" style="background:#F59E0B;"></div> Previous MAE (history)
                    </div>
                </div>
                <div class="compare-wrap">
                    <canvas id="compareChart"></canvas>
                </div>
                <div id="compare-verdict" style="display:none;"></div>

                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="runCompare()">‚Üª Refresh Comparison</button>
                </div>
            </div>
            <div class="log-box" id="log-5"></div>
        </div>

    </div>

    <script>
        /* ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        const clientId = document.getElementById('client-id').value;
        let globalState = null;
        let globalSchema = null;   // {columns:[], means:[], stds:[], registered:bool}
        let csvRawSource = null;
        let trainingSet = null;
        let localWeights = null;
        let localRmse = null;
        let localMae = null;
        let uploadMode = 'clean';       // 'clean' | 'dirty'
        let colHistChart = null;
        let lossChartInst = null;
        let compareChartInst = null;
        let epochStartTime = null;

        /* ‚îÄ‚îÄ Chart Setup: Loss ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        const lossCtx = document.getElementById('lossChart').getContext('2d');
        lossChartInst = new Chart(lossCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Training Loss',
                    data: [],
                    borderColor: '#6366F1',
                    backgroundColor: 'rgba(99,102,241,0.06)',
                    tension: 0.4,
                    pointRadius: 2,
                    fill: true,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { display: false },
                    y: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#4B5563', font: { size: 10 } } }
                },
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });

        /* ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        function log(id, msg, cls = 'log-info') {
            const box = document.getElementById(`log-${id}`);
            box.classList.add('show');
            const div = document.createElement('div');
            div.className = cls;
            div.innerHTML = `<span style="opacity:0.4">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function setStatus(id, text, cls = '') {
            const el = document.getElementById(`st-${id}`);
            el.textContent = text;
            el.className = `cell-status ${cls}`;
        }

        function advanceRail(step) {
            // mark all steps up to step as done, step as active
            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById(`rail-${i}`);
                el.className = 'rail-step' + (i < step ? ' done' : i === step ? ' active' : '');
            }
        }

        function setMode(mode) {
            uploadMode = mode;
            document.getElementById('tab-clean').className = 'mode-tab' + (mode === 'clean' ? ' active' : '');
            document.getElementById('tab-dirty').className = 'mode-tab' + (mode === 'dirty' ? ' active' : '');
            document.getElementById('mode-desc').textContent = mode === 'clean'
                ? 'Upload a clean, numeric CSV file. Select the target column (Y) before processing.'
                : 'Upload a raw or messy CSV. The system will send it to the server for cleaning (column union, fill missing values with 0, coerce types) and reload it automatically.';
        }

        function transpose(m) { return m[0].map((_, i) => m.map(r => r[i])); }
        function multiply(v, f) { return Array.isArray(v) ? v.map(i => multiply(i, f)) : v * f; }

        /* ‚îÄ‚îÄ CELL 1: Sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        async function runSync() {
            advanceRail(1);
            setStatus(1, 'Running‚Ä¶', 'running');
            document.getElementById('btn-sync').disabled = true;
            log(1, 'Pulling global model parameters from Fedora Hub‚Ä¶');

            try {
                const [modelRes, schemaRes] = await Promise.all([
                    fetch('/api/model'),
                    fetch('/api/schema')
                ]);
                globalState = await modelRes.json();
                globalSchema = await schemaRes.json();

                log(1, `Global model synced ‚Äî version: <span class="log-ok">v${globalState.version}</span>`);
                log(1, `Architecture: MLP | Input dim: <span style="color:var(--accent2)">${globalState.input_shape[0]}</span> | Output: <span style="color:var(--accent2)">${globalState.num_classes}</span>`);

                if (globalSchema.registered) {
                    log(1, `<span class="log-ok">‚úÖ Global feature schema</span> ‚Äî <strong>${globalSchema.count}</strong> canonical features loaded. Uploads will be auto-harmonised.`);
                } else {
                    log(1, `<span style="color:var(--warn)">‚ö†Ô∏è No feature schema registered yet.</span> First upload will define the canonical schema.`, 'log-warn');
                }

                const pills = document.getElementById('info-row-1');
                pills.style.display = 'flex';
                pills.innerHTML = `
                    <span class="info-pill">v${globalState.version}</span>
                    <span class="info-pill">${globalState.input_shape[0]} features</span>
                    <span class="info-pill">${globalState.num_classes} outputs</span>
                    ${globalSchema.registered ? `<span class="info-pill" style="border-color:rgba(16,185,129,0.3);color:var(--success);">Schema ‚úì</span>` : `<span class="info-pill" style="border-color:rgba(245,158,11,0.3);color:var(--warn);">No Schema</span>`}
                `;

                setStatus(1, 'Done', 'ok');
                document.getElementById('cell-1').classList.add('done-cell');
                advanceRail(2);
            } catch (e) {
                log(1, `Failed: ${e.message}`, 'log-err');
                setStatus(1, 'Error', 'fail');
                document.getElementById('cell-1').classList.add('error-cell');
                document.getElementById('btn-sync').disabled = false;
            }
        }

        /* ‚îÄ‚îÄ CELL 2: File Handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        async function handleFile(file) {
            if (!file) return;
            document.getElementById('drop-zone').innerHTML = `<div class="dz-icon">‚è≥</div><div class="dz-text">Loading <strong>${file.name}</strong>‚Ä¶</div>`;

            if (uploadMode === 'dirty') {
                log(2, `Uploading <em>${file.name}</em> to /api/clean-csv for cleaning‚Ä¶`, 'log-warn');
                setStatus(2, 'Cleaning‚Ä¶', 'running');
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const res = await fetch('/api/clean-csv', { method: 'POST', body: formData });
                    if (!res.ok) {
                        const err = await res.json();
                        throw new Error(err.detail || 'Clean failed');
                    }
                    const cleanedText = await res.text();
                    log(2, `Server cleaned the CSV ‚Äî received ${cleanedText.split('\n').length - 2} rows.`, 'log-ok');
                    // Parse the cleaned text
                    parseCsvText(cleanedText, file.name + ' (cleaned)');
                } catch (e) {
                    log(2, `Cleaning failed: ${e.message}`, 'log-err');
                    setStatus(2, 'Error', 'fail');
                    document.getElementById('drop-zone').innerHTML = `<div class="dz-icon">‚ùå</div><div class="dz-text">${e.message}</div>`;
                }
            } else {
                // Clean mode ‚Äî parse directly
                const reader = new FileReader();
                reader.onload = (ev) => parseCsvText(ev.target.result, file.name);
                reader.readAsText(file);
            }
        }

        /* ‚îÄ‚îÄ Feature Alignment Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        /**
         * Harmonise parsed PapaParse rows to match canonical schema.
         * Returns { alignedData, alignedFields, report }
         *   report = { added: [...], dropped: [...], reordered: bool, ok: bool }
         */
        function alignToSchema(parsedData, parsedFields, schema) {
            const canonical = schema.columns;
            const uploadedSet = new Set(parsedFields);
            const canonicalSet = new Set(canonical);

            const added = canonical.filter(c => !uploadedSet.has(c));
            // "extra" = columns NOT in the feature schema (e.g. price, SalePrice, charges)
            // We KEEP these ‚Äî they are candidate target columns the user needs to select.
            const extra = parsedFields.filter(c => !canonicalSet.has(c));
            const reordered = JSON.stringify(parsedFields.filter(c => canonicalSet.has(c))) !==
                JSON.stringify(canonical.filter(c => uploadedSet.has(c)));

            // Build mean lookup for padding missing schema features
            const meansMap = {};
            canonical.forEach((col, i) => { meansMap[col] = (schema.means && schema.means[i] != null) ? schema.means[i] : 0; });

            // Column order: schema features first, then extra cols (price/target lives here)
            const alignedFields = [...canonical, ...extra];

            const alignedData = parsedData.map(row => {
                const newRow = {};
                // Schema features ‚Äî pad missing with mean
                canonical.forEach(col => {
                    newRow[col] = (row[col] !== undefined && row[col] !== null) ? row[col] : meansMap[col];
                });
                // Extra cols (target column) ‚Äî carry through unchanged
                extra.forEach(col => { newRow[col] = row[col]; });
                return newRow;
            });

            return {
                alignedData,
                alignedFields,   // schema features + extra target col(s)
                report: {
                    added,
                    extra,   // non-schema cols kept for target selection
                    reordered,
                    ok: added.length === 0 && extra.length === 0 && !reordered
                }
            };
        }

        function renderAlignmentBanner(report, originalCount, canonicalCount, logId) {
            if (report.ok) {
                log(logId, `<span class="log-ok">‚úÖ Schema match ‚Äî ${canonicalCount} columns align perfectly with the global schema.</span>`);
                return;
            }
            log(logId, `<span style="color:var(--accent2)">üîß Feature Harmonization applied ‚Äî dataset auto-aligned to global schema.</span>`);
            if (report.added.length > 0) {
                log(logId, `<span style="color:var(--accent)">‚ûï ${report.added.length} missing column(s) padded with schema mean: <em>${report.added.slice(0, 5).join(', ')}${report.added.length > 5 ? ` ‚Ä¶+${report.added.length - 5} more` : ''}</em></span>`);
            }
            if (report.extra && report.extra.length > 0) {
                log(logId, `<span style="color:var(--muted)">üìå ${report.extra.length} non-schema column(s) kept for target selection: <em>${report.extra.slice(0, 5).join(', ')}${report.extra.length > 5 ? ` ‚Ä¶+${report.extra.length - 5} more` : ''}</em></span>`);
            }
            if (report.reordered) {
                log(logId, `<span style="color:var(--muted)">‚ÜïÔ∏è Column order normalised to match schema.</span>`);
            }
            log(logId, `<span class="log-ok">‚úÖ Alignment complete: ${originalCount} cols ‚Üí ${canonicalCount} cols. Training can proceed.</span>`);
        }

        async function parseCsvText(csvText, displayName) {
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (r) => {
                    let parsedData = r.data;
                    let parsedFields = r.meta.fields || [];
                    const originalColCount = parsedFields.length;

                    // ‚îÄ‚îÄ Feature Alignment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    if (globalSchema && globalSchema.registered && globalSchema.columns.length > 0) {
                        const { alignedData, alignedFields, report } = alignToSchema(parsedData, parsedFields, globalSchema);
                        renderAlignmentBanner(report, originalColCount, alignedFields.length, 2);
                        parsedData = alignedData;
                        parsedFields = alignedFields;
                        // Rebuild a PapaParse-compatible structure with aligned data
                        r = { ...r, data: alignedData, meta: { ...r.meta, fields: alignedFields } };
                    } else if (!globalSchema || !globalSchema.registered) {
                        // First upload ‚Äî this will register the schema after processing
                        log(2, `<span style="color:var(--warn)">‚ö†Ô∏è No canonical schema registered. This dataset (${parsedFields.length} columns) will become the reference schema.</span>`, 'log-warn');
                    }

                    // ‚îÄ‚îÄ Store aligned data & populate target selector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                    document.getElementById('cell-2').classList.remove('error-cell');
                    csvRawSource = r;
                    const select = document.getElementById('target-col');
                    select.innerHTML = '';
                    parsedFields.forEach(f => {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = f;
                        select.appendChild(opt);
                    });

                    // Smart default: guess target column by common regression names
                    const targetKeywords = ['price', 'saleprice', 'medv', 'charges', 'yield',
                        'salary', 'revenue', 'cost', 'value', 'target', 'label', 'output',
                        'hg/ha_yield', 'selling_price', 'resale_price'];
                    const lowerCols = parsedFields.map(c => c.toLowerCase());
                    const guessedIdx = lowerCols.findIndex(c => targetKeywords.some(k => c.includes(k)));
                    select.selectedIndex = guessedIdx >= 0 ? guessedIdx : parsedFields.length - 1;

                    document.getElementById('col-settings').style.display = 'block';
                    document.getElementById('drop-zone').innerHTML = `
                        <div class="dz-icon" style="opacity:1">‚úÖ</div>
                        <div class="dz-text"><strong>${displayName}</strong> ‚Äî ${parsedData.length} rows ¬∑ ${parsedFields.length} columns</div>
                    `;
                    document.getElementById('drop-zone').classList.add('loaded');
                    log(2, `CSV loaded: <span class="log-ok">${parsedData.length} rows, ${parsedFields.length} features</span>`);

                    setStatus(2, 'Loaded', 'ok');
                },
                error: (e) => {
                    log(2, `Parse error: ${e.message}`, 'log-err');
                }
            });
        }


        function processData() {
            if (!csvRawSource || !globalState) {
                log(2, 'Run Cell 1 (Sync) first, or upload a CSV file.', 'log-warn');
                return;
            }
            const target = document.getElementById('target-col').value;
            const allCols = csvRawSource.meta.fields;
            const featureCols = allCols.filter(c => c !== target);
            const inputDim = globalState.input_shape[0];

            // ‚îÄ‚îÄ Build raw feature matrix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const rawMatrix = csvRawSource.data.map(row =>
                featureCols.map(c => { const v = parseFloat(row[c]); return isNaN(v) ? 0 : v; })
            );

            // ‚îÄ‚îÄ Per-column mean & std ‚îÄ‚îÄ use global schema stats when available ‚îÄ
            // Using global schema scaler statistics ensures preprocessing consistency
            // across all federated clients, which is critical for weight compatibility.
            const nRows = rawMatrix.length;
            let colMeans, colStds;

            const useGlobalScaler = globalSchema && globalSchema.registered &&
                globalSchema.means && globalSchema.means.length > 0 &&
                // Only use global scaler if schema columns match our feature cols (modulo target)
                globalSchema.columns.filter(c => c !== target).length === featureCols.length;

            if (useGlobalScaler) {
                // Map schema means/stds to the feature column order (excluding target)
                const schemaFeatures = globalSchema.columns.filter(c => c !== target);
                colMeans = featureCols.map(col => {
                    const si = schemaFeatures.indexOf(col);
                    const schemaMean = si >= 0 ? globalSchema.means[si] : null;
                    // Fall back to local mean if schema doesn't have it
                    if (schemaMean === null || schemaMean === undefined) {
                        return rawMatrix.reduce((s, r) => s + r[featureCols.indexOf(col)], 0) / nRows;
                    }
                    return schemaMean;
                });
                colStds = featureCols.map(col => {
                    const si = schemaFeatures.indexOf(col);
                    const schemaStd = si >= 0 ? globalSchema.stds[si] : null;
                    if (schemaStd === null || schemaStd === undefined || schemaStd < 1e-8) {
                        const ci = featureCols.indexOf(col);
                        const mean = colMeans[ci];
                        return Math.sqrt(rawMatrix.reduce((s, r) => s + (r[ci] - mean) ** 2, 0) / nRows);
                    }
                    return schemaStd;
                });
                log(2, `<span class="log-ok">üìê Using global schema scaler statistics for preprocessing consistency.</span>`);
            } else {
                // Local compute (first upload / no schema yet)
                colMeans = featureCols.map((_, ci) => rawMatrix.reduce((s, r) => s + r[ci], 0) / nRows);
                colStds = featureCols.map((_, ci) => {
                    const mean = colMeans[ci];
                    return Math.sqrt(rawMatrix.reduce((s, r) => s + (r[ci] - mean) ** 2, 0) / nRows);
                });
                // Register local stats as global scaler (first-time only; server ignores if already set)
                fetch('/api/register-schema', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ columns: featureCols, means: colMeans, stds: colStds })
                }).then(res => res.json()).then(data => {
                    if (data.features) {
                        globalSchema = { registered: true, columns: data.features, means: colMeans, stds: colStds, count: data.count };
                        log(2, `<span class="log-ok">üìã Schema registered ‚Äî ${data.count} features + scaler stats saved.</span>`);
                    }
                }).catch(() => { });
            }

            // ‚îÄ‚îÄ Drop zero-variance columns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const goodCols = featureCols.filter((_, ci) => colStds[ci] > 1e-6);
            const droppedCols = featureCols.filter((_, ci) => colStds[ci] <= 1e-6);
            if (droppedCols.length > 0)
                log(2, `<span style="color:var(--warn)">Dropped ${droppedCols.length} zero-variance column(s): ${droppedCols.join(', ')}</span>`);

            // ‚îÄ‚îÄ Normalize (Z-score) and pad/truncate to model input dim ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const goodIndices = featureCols.map((_, i) => i).filter(i => colStds[i] > 1e-6);
            const X = rawMatrix.map(row => {
                let feats = goodIndices.map(i => (row[i] - colMeans[i]) / (colStds[i] + 1e-8));
                if (feats.length < inputDim) feats = [...feats, ...Array(inputDim - feats.length).fill(0)];
                return feats.slice(0, inputDim);
            });

            // ‚îÄ‚îÄ Normalize target (Y) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const yRaw = csvRawSource.data.map(row => { const v = parseFloat(row[target]); return isNaN(v) ? 0 : v; });
            const yMean = yRaw.reduce((s, v) => s + v, 0) / yRaw.length;
            const yStd = Math.sqrt(yRaw.reduce((s, v) => s + (v - yMean) ** 2, 0) / yRaw.length) + 1e-8;
            const y = yRaw.map(v => [(v - yMean) / yStd]);

            trainingSet = { X: tf.tensor2d(X), y: tf.tensor2d(y), yMean, yStd };
            log(2, `<span class="log-ok">Preprocessed: ${X.length} rows √ó ${goodCols.length} features ‚Üí padded to ${inputDim}</span>. Target: <span style="color:var(--accent2)">${target}</span>`);
            log(2, `Target stats: mean=<strong>${yMean.toFixed(0)}</strong> std=<strong>${yStd.toFixed(0)}</strong>`);

            // ‚îÄ‚îÄ Column Histogram ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const displayCols = featureCols.slice(0, 12);
            const histMeans = displayCols.map(c => {
                const vals = csvRawSource.data.map(r => parseFloat(r[c]) || 0);
                return vals.reduce((a, b) => a + b, 0) / vals.length;
            });
            const histStds = displayCols.map((c, i) => {
                const vals = csvRawSource.data.map(r => parseFloat(r[c]) || 0);
                const m = histMeans[i];
                return Math.sqrt(vals.reduce((a, b) => a + (b - m) ** 2, 0) / vals.length);
            });

            if (colHistChart) colHistChart.destroy();
            const hCtx = document.getElementById('colHistChart').getContext('2d');
            colHistChart = new Chart(hCtx, {
                type: 'bar',
                data: {
                    labels: displayCols.map(c => c.length > 8 ? c.slice(0, 8) + '‚Ä¶' : c),
                    datasets: [
                        { label: 'Mean', data: histMeans, backgroundColor: 'rgba(99,102,241,0.6)', borderColor: '#6366F1', borderWidth: 1 },
                        { label: 'Std Dev', data: histStds, backgroundColor: 'rgba(34,211,238,0.35)', borderColor: '#22D3EE', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#4B5563', font: { size: 9 } }, grid: { display: false } },
                        y: { ticks: { color: '#4B5563', font: { size: 9 } }, grid: { color: 'rgba(255,255,255,0.04)' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#64748B', font: { size: 9 }, boxWidth: 10 } },
                        tooltip: { backgroundColor: 'rgba(6,9,15,0.95)', titleColor: '#E2E8F0', bodyColor: '#94A3B8' }
                    }
                }
            });

            // ‚îÄ‚îÄ Data Preview Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const previewRows = csvRawSource.data.slice(0, 5);
            const previewCols = allCols.slice(0, 8);
            let tableHTML = '<table><thead><tr>';
            previewCols.forEach(c => tableHTML += `<th>${c}</th>`);
            tableHTML += '</tr></thead><tbody>';
            previewRows.forEach(row => {
                tableHTML += '<tr>';
                previewCols.forEach(c => tableHTML += `<td>${row[c] !== undefined ? row[c] : '‚Äî'}</td>`);
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            document.getElementById('dataTableWrap').innerHTML = tableHTML;
            document.getElementById('data-preview').style.display = 'block';

            // Info pills
            document.getElementById('data-info-pills').innerHTML = `
                <span class="info-pill">${X.length} rows</span>
                <span class="info-pill">${goodCols.length} features used</span>
                <span class="info-pill">${droppedCols.length} dropped</span>
                <span class="info-pill">Target: ${target}</span>
                <span class="info-pill">Model dim: ${inputDim}</span>
            `;

            document.getElementById('cell-2').classList.add('done-cell');
            advanceRail(3);
        }

        /* ‚îÄ‚îÄ CELL 3: Training ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        async function runTrain() {
            if (!trainingSet || !globalState) { log(3, 'Complete Cells 1 & 2 first.', 'log-warn'); return; }
            setStatus(3, 'Training‚Ä¶', 'running');
            document.getElementById('btn-train').disabled = true;
            log(3, 'Initializing TensorFlow.js optimizer‚Ä¶');

            lossChartInst.data.labels = [];
            lossChartInst.data.datasets[0].data = [];
            lossChartInst.update();

            const model = tf.sequential({
                layers: [
                    tf.layers.dense({ inputShape: [globalState.input_shape[0]], units: 128, activation: 'relu', kernelRegularizer: tf.regularizers.l2({ l2: 0.001 }) }),
                    tf.layers.dropout({ rate: 0.2 }),
                    tf.layers.dense({ units: 64, activation: 'relu' }),
                    tf.layers.dense({ units: globalState.num_classes })
                ]
            });
            model.compile({ optimizer: tf.train.adam(parseFloat(document.getElementById('lr').value)), loss: 'meanSquaredError', metrics: ['mae'] });

            const totalEpochs = parseInt(document.getElementById('epochs').value);
            epochStartTime = Date.now();
            let baseLoss = null;

            document.getElementById('epoch-table-container').style.display = 'block';
            const epochTableBody = document.querySelector('#epoch-table tbody');
            epochTableBody.innerHTML = '';

            await model.fit(trainingSet.X, trainingSet.y, {
                epochs: totalEpochs,
                batchSize: 32,
                callbacks: {
                    onEpochEnd: (e, logs) => {
                        lossChartInst.data.labels.push(e + 1);
                        lossChartInst.data.datasets[0].data.push(logs.loss);
                        lossChartInst.update('none');
                        document.getElementById('epoch-counter').textContent = `Epoch: ${e + 1} / ${totalEpochs}  |  Loss: ${logs.loss.toFixed(5)}`;
                        const elapsed = (Date.now() - epochStartTime) / 1000;
                        const eta = Math.round((elapsed / (e + 1)) * (totalEpochs - e - 1));
                        document.getElementById('eta-text').textContent = e + 1 < totalEpochs ? `ETA: ${eta}s` : 'Complete';

                        if (baseLoss === null) baseLoss = logs.loss;
                        const improvement = baseLoss > 0 ? ((baseLoss - logs.loss) / baseLoss * 100) : 0;
                        const impColor = improvement >= 0 ? 'var(--success)' : 'var(--danger)';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${e + 1}</td>
                            <td>${logs.loss.toFixed(5)}</td>
                            <td>${logs.mae.toFixed(5)}</td>
                            <td><strong style="color:${impColor}">${improvement >= 0 ? '+' : ''}${improvement.toFixed(1)}%</strong></td>
                            <td><span style="color:var(--success)">OK</span></td>
                        `;
                        epochTableBody.prepend(row);
                    }
                }
            });

            // ‚îÄ‚îÄ Compute local RMSE & MAE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const preds = model.predict(trainingSet.X);
            const predsArr = await preds.array();
            const trueArr = await trainingSet.y.array();

            let sumSE = 0, sumAE = 0;
            const n = trueArr.length;
            for (let i = 0; i < n; i++) {
                const err = predsArr[i][0] - trueArr[i][0];
                sumSE += err * err;
                sumAE += Math.abs(err);
            }
            localRmse = Math.sqrt(sumSE / n);
            localMae = sumAE / n;

            preds.dispose();
            log(3, `Training complete ‚Äî Local <span class="log-ok">RMSE: ${localRmse.toFixed(4)}</span> | <span style="color:var(--accent2)">MAE: ${localMae.toFixed(4)}</span>`, 'log-ok');

            // Serialize weights
            const tfW = model.getWeights();
            localWeights = {
                'model.0.weight': transpose(await tfW[0].array()),
                'model.0.bias': await tfW[1].array(),
                'model.2.weight': transpose(await tfW[2].array()),
                'model.2.bias': await tfW[3].array(),
                'model.4.weight': transpose(await tfW[4].array()),
                'model.4.bias': await tfW[5].array(),
            };

            setStatus(3, 'Done', 'ok');
            document.getElementById('cell-3').classList.add('done-cell');
            document.getElementById('btn-train').disabled = false;
            advanceRail(4);
        }

        /* ‚îÄ‚îÄ CELL 4: Push ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        async function runPush() {
            if (!localWeights) { log(4, 'Run training first (Cell 3).', 'log-warn'); return; }
            setStatus(4, 'Pushing‚Ä¶', 'running');
            document.getElementById('btn-push').disabled = true;

            let submissionWeights = JSON.parse(JSON.stringify(localWeights));

            if (document.getElementById('malicious-mode').checked) {
                log(4, '<span class="log-err">‚ö† Simulating Gradient Sign-Flip attack‚Ä¶</span>');
                Object.keys(submissionWeights).forEach(k => {
                    submissionWeights[k] = multiply(submissionWeights[k], -5000.0);
                });
            }

            log(4, 'Submitting weight update to Fedora Hub‚Ä¶');
            try {
                const payload = {
                    client_id: clientId,
                    weights: submissionWeights,
                    base_version: globalState ? globalState.version : 0,
                    local_rmse: localRmse,
                    local_mae: localMae,
                };
                const res = await fetch('/api/submit-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                const data = await res.json();

                if (res.ok && data.status === 'accepted') {
                    log(4, `<span class="log-ok">‚úÖ AGGREGATED ‚Äî Global model evolved to v${data.new_version} (trimmed-mean)</span>`);
                    setStatus(4, 'Accepted', 'ok');
                    document.getElementById('cell-4').classList.add('done-cell');
                    advanceRail(5);
                    runCompare();
                } else if (res.ok && data.status === 'buffered') {
                    log(4, `<span style="color:var(--warn)">üì• BUFFERED ‚Äî Delta queued (${data.buffer_depth}/${data.buffer_capacity}). Staleness: ${data.staleness}. Model will aggregate after ${data.buffer_capacity} updates.</span>`);
                    setStatus(4, 'Buffered', 'ok');
                    document.getElementById('cell-4').classList.add('done-cell');
                    advanceRail(5);
                } else {
                    const failMsg = data.reason || 'Submission failed';
                    log(4, `<span class="log-err">‚õî REJECTED ‚Äî ${failMsg}</span>`, 'log-err');
                    setStatus(4, 'Rejected', 'fail');
                    document.getElementById('cell-4').classList.add('error-cell');
                }
            } catch (e) {
                log(4, `Network error: ${e.message}`, 'log-err');
                setStatus(4, 'Error', 'fail');
            }
            document.getElementById('btn-push').disabled = false;
        }

        /* ‚îÄ‚îÄ CELL 5: Compare ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        async function runCompare() {
            setStatus(5, 'Fetching‚Ä¶', 'running');
            log(5, 'Fetching metrics history from Fedora Hub‚Ä¶');

            try {
                const res = await fetch(`/api/metrics-history?client_id=${encodeURIComponent(clientId)}&limit=10`);
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();

                const history = (data.history || []).reverse(); // oldest first
                const labels = history.length ? history.map((h, i) => `R${i + 1}`) : ['This Run'];
                const prevRmse = history.map(h => h.local_rmse);
                const prevMae = history.map(h => h.local_mae);

                // Current session data
                const currentLabels = labels;
                const currentRmseArr = currentLabels.map(() => localRmse);

                // Global Benchmark data (constant line)
                const globalRmseArr = currentLabels.map(() => data.global_best_rmse || 0);

                if (compareChartInst) compareChartInst.destroy();
                const cCtx = document.getElementById('compareChart').getContext('2d');
                compareChartInst = new Chart(cCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Local RMSE (this session)',
                                data: localRmse !== null ? currentRmseArr : [],
                                backgroundColor: 'rgba(99,102,241,0.7)',
                                borderColor: '#6366F1',
                                borderWidth: 1,
                                order: 2
                            },
                            {
                                label: 'Federation Benchmark (Target)',
                                data: globalRmseArr,
                                type: 'line',
                                borderColor: 'rgba(16, 185, 129, 0.8)',
                                borderDash: [5, 5],
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false,
                                order: 1
                            },
                            {
                                label: 'Prev RMSE (history)',
                                data: prevRmse,
                                backgroundColor: 'rgba(34,211,238,0.5)',
                                borderColor: '#22D3EE',
                                borderWidth: 1,
                                order: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { ticks: { color: '#4B5563', font: { size: 10 } }, grid: { display: false } },
                            y: { ticks: { color: '#4B5563', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#94A3B8', font: { size: 10 }, boxWidth: 10 } },
                            tooltip: { backgroundColor: 'rgba(6,9,15,0.95)', titleColor: '#E2E8F0', bodyColor: '#94A3B8', padding: 12 }
                        }
                    }
                });

                // Verdict
                const verdictEl = document.getElementById('compare-verdict');
                verdictEl.style.display = 'block';

                const benchmark = data.global_best_rmse;

                if (localRmse === null) {
                    verdictEl.className = 'compare-verdict verdict-equal';
                    verdictEl.textContent = 'Train locally first to see your comparison verdict.';
                } else if (benchmark === null || benchmark === 0) {
                    verdictEl.className = 'compare-verdict verdict-equal';
                    verdictEl.textContent = 'üîµ First contribution ‚Äî you are setting the federation benchmark!';
                } else {
                    const diff = ((localRmse - benchmark) / benchmark) * 100;
                    if (localRmse < benchmark * 0.99) {
                        verdictEl.className = 'compare-verdict verdict-better';
                        verdictEl.innerHTML = `‚úÖ <strong>Better than Federation!</strong> Your RMSE is <strong>${Math.abs(diff).toFixed(1)}% lower</strong> than the current global benchmark.`;
                    } else if (localRmse > benchmark * 1.05) {
                        verdictEl.className = 'compare-verdict verdict-worse';
                        verdictEl.innerHTML = `‚ö†Ô∏è <strong>Below Target</strong> ‚Äî Your RMSE is <strong>${diff.toFixed(1)}% higher</strong> than the global benchmark. Aggregation might be rejected if too high.`;
                    } else {
                        verdictEl.className = 'compare-verdict verdict-equal';
                        verdictEl.innerHTML = `üîµ <strong>On Par</strong> ‚Äî Your local model is within <strong>${Math.abs(diff).toFixed(1)}%</strong> of the federation benchmark.`;
                    }
                }

                log(5, `Loaded ${history.length} historical rounds. Global model: <span class="log-ok">v${data.global_version}</span>`, 'log-ok');
                setStatus(5, 'Done', 'ok');
                document.getElementById('cell-5').classList.add('done-cell');

            } catch (e) {
                log(5, `Comparison failed: ${e.message}`, 'log-err');
                setStatus(5, 'Error', 'fail');
            }
        }
    </script>

</body>

{% endblock %}